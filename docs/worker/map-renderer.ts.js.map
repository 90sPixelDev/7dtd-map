{"version":3,"file":"worker/map-renderer.ts.js","mappings":"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","sources":["webpack://7dtd-map/./src/lib/image-bitmap-holder.ts","webpack://7dtd-map/./src/lib/map-renderer.ts","webpack://7dtd-map/./src/lib/throttled-invoker.ts","webpack://7dtd-map/./src/lib/utils.ts","webpack://7dtd-map/./src/worker/map-renderer.ts","webpack://7dtd-map/webpack/bootstrap","webpack://7dtd-map/webpack/startup"],"sourcesContent":["import { imageBitmapToPngBlob, requireNonnull } from \"./utils\";\n\nconst IMG_AGE_MSEC = 10000;\n\nexport class ImageBitmapHolder {\n  private label;\n  _png: PngBlob | Promise<PngBlob>;\n  private img?: ImageBitmap | null;\n  private fallbackPromise: Promise<ImageBitmap> | null = null;\n  private lastAccessAt = 0;\n  private imgAge;\n\n  constructor(label: string, original: PngBlob | ImageBitmap, imgAge = IMG_AGE_MSEC) {\n    this.label = label;\n    if (isPngBlob(original)) {\n      this._png = original;\n    } else {\n      this._png = imageBitmapToPngBlob(original);\n      this.setImg(original);\n    }\n    this.imgAge = imgAge;\n  }\n\n  async get(): Promise<ImageBitmap> {\n    this.lastAccessAt = Date.now();\n    return this.img ?? this.fallbackPromise ?? this.getFallback();\n  }\n\n  private async getFallback() {\n    this.fallbackPromise = this.getImageBitmap();\n    return this.fallbackPromise;\n  }\n\n  private async getImageBitmap() {\n    console.debug(\"Fallback\", this.label);\n    const img = await createImageBitmap(await this._png);\n    this.setImg(img);\n    this.fallbackPromise = null;\n    return img;\n  }\n\n  private setImg(img: ImageBitmap) {\n    this.img = img;\n    setTimeout(() => this.expireImage(), this.imgAge);\n  }\n\n  private expireImage() {\n    if (Date.now() - this.lastAccessAt > this.imgAge) {\n      console.debug(\"Expire\", this.label);\n      requireNonnull(this.img).close();\n      this.img = null;\n    } else {\n      setTimeout(() => this.expireImage(), this.imgAge);\n    }\n  }\n}\n\nfunction isPngBlob(o: PngBlob | ImageBitmap): o is PngBlob {\n  return o instanceof Blob;\n}\n","import { ImageBitmapHolder } from \"./image-bitmap-holder\";\nimport { throttledInvoker } from \"./throttled-invoker\";\nimport { gameMapSize } from \"./utils\";\n\nconst MARK_CHAR = \"🚩️\";\n\nexport interface POIInfo {\n  prefabName: string;\n  x: number;\n  y: number;\n  z: number;\n}\nexport interface SignChar {\n  text: string;\n  ctx: {\n    fillStyle: string;\n    strokeStyle: string;\n  };\n}\n\nexport default class MapRenderer {\n  brightness = \"100%\";\n  markerCoords: GameCoords | null = null;\n  scale = 0.1;\n  showPrefabs = true;\n  showToolTips = false;\n  prefabs: HighlightedPrefab[] = [];\n  signSize = 200;\n  markerSize = 100;\n  toolTipSize = 300;\n  signAlpha = 1;\n  biomesAlpha = 1;\n  splat3Alpha = 1;\n  splat4Alpha = 1;\n  radAlpha = 1;\n\n  canvas: OffscreenCanvas;\n\n  update = throttledInvoker(async () => {\n    console.time(\"MapUpdate\");\n    await this.updateImmediately();\n    console.timeEnd(\"MapUpdate\");\n  });\n\n  private _biomesImg: ImageBitmapHolder | null = null;\n  private _splat3Img: ImageBitmapHolder | null = null;\n  private _splat4Img: ImageBitmapHolder | null = null;\n  private _radImg: ImageBitmapHolder | null = null;\n  private fontFace: FontFace;\n  private toolTipFontFace: FontFace;\n\n  constructor(canvas: OffscreenCanvas, fontFace: FontFace, toolTipFontFace: FontFace) {\n    this.canvas = canvas;\n    this.fontFace = fontFace;\n    this.toolTipFontFace = toolTipFontFace;\n  }\n\n  set biomesImg(img: ImageBitmap | PngBlob | null) {\n    this._biomesImg = img ? new ImageBitmapHolder(\"biomes\", img) : null;\n  }\n  set splat3Img(img: ImageBitmap | PngBlob | null) {\n    this._splat3Img = img ? new ImageBitmapHolder(\"splat3\", img) : null;\n  }\n  set splat4Img(img: ImageBitmap | PngBlob | null) {\n    this._splat4Img = img ? new ImageBitmapHolder(\"splat4\", img) : null;\n  }\n  set radImg(img: ImageBitmap | PngBlob | null) {\n    this._radImg = img ? new ImageBitmapHolder(\"rad\", img) : null;\n  }\n\n  async size(): Promise<GameMapSize> {\n    const rects = await Promise.all([this._biomesImg?.get(), this._splat3Img?.get(), this._splat4Img?.get()]);\n    return gameMapSize({\n      width: Math.max(...rects.map((r) => r?.width ?? 0)),\n      height: Math.max(...rects.map((r) => r?.height ?? 0)),\n    });\n  }\n\n  private isBlank(): boolean {\n    return !this._biomesImg && !this._splat3Img && !this._splat4Img;\n  }\n\n  async updateImmediately(): Promise<void> {\n    if (this.isBlank()) {\n      this.canvas.width = 1;\n      this.canvas.height = 1;\n      return;\n    }\n\n    const { width, height } = await this.size();\n\n    this.canvas.width = width * this.scale;\n    this.canvas.height = height * this.scale;\n\n    const context = this.canvas.getContext(\"2d\");\n    if (!context) return;\n    context.scale(this.scale, this.scale);\n    context.filter = `brightness(${this.brightness})`;\n\n    if (this._biomesImg && this.biomesAlpha !== 0) {\n      context.globalAlpha = this.biomesAlpha;\n      context.drawImage(await this._biomesImg.get(), 0, 0, width, height);\n    }\n    if (this._splat3Img && this.splat3Alpha !== 0) {\n      context.globalAlpha = this.splat3Alpha;\n      context.drawImage(await this._splat3Img.get(), 0, 0, width, height);\n    }\n    if (this._splat4Img && this.splat4Alpha !== 0) {\n      context.globalAlpha = this.splat4Alpha;\n      context.drawImage(await this._splat4Img.get(), 0, 0, width, height);\n    }\n\n    context.filter = \"none\";\n    if (this._radImg && this.radAlpha !== 0) {\n      context.globalAlpha = this.radAlpha;\n      context.imageSmoothingEnabled = false;\n      context.drawImage(await this._radImg.get(), 0, 0, width, height);\n      context.imageSmoothingEnabled = true;\n    }\n\n    context.globalAlpha = this.signAlpha;\n    if (this.showPrefabs) {\n      this.drawPrefabs(context, width, height);\n    }\n    if (this.markerCoords) {\n      this.drawMark(context, width, height);\n    }\n  }\n\n  private customizeSignByPrefabCategory(prefab: HighlightedPrefab) {\n    const pfName = prefab.name.toLocaleLowerCase();\n    let prefabInfo: SignChar = { text: \"❌\", ctx: { fillStyle: \"white\", strokeStyle: \"#000\" } };\n\n    if (pfName.includes(\"filler\")) {\n      prefabInfo = { text: \"🔶\", ctx: { fillStyle: \"gray\", strokeStyle: \"#1C2F51\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"part\") && !pfName.includes(\"apartment\")) {\n      prefabInfo = { text: \"\", ctx: { fillStyle: \"#576D98\", strokeStyle: \"#374869\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"gas\")) {\n      prefabInfo = { text: \"⛽\", ctx: { fillStyle: \"red\", strokeStyle: \"#5E1616\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"trader\") && !pfName.includes(\"filler\")) {\n      prefabInfo = { text: \"💰\", ctx: { fillStyle: \"yellow\", strokeStyle: \"#A47D00\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"sham\")) {\n      prefabInfo = { text: \"🥫\", ctx: { fillStyle: \"yellow\", strokeStyle: \"white\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"farm\") || pfName.includes(\"barn\")) {\n      prefabInfo = { text: \"🚜\", ctx: { fillStyle: \"orange\", strokeStyle: \"#704D17\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"survivor\")) {\n      prefabInfo = { text: \"👤\", ctx: { fillStyle: \"purple\", strokeStyle: \"#17072C\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"skyscraper\") && !pfName.includes(\"filler\")) {\n      prefabInfo = { text: \"🏢\", ctx: { fillStyle: \"#8FA5CF\", strokeStyle: \"#1C2F51\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"hospital\") || pfName.includes(\"clinic\") || pfName.includes(\"pharmacy\")) {\n      prefabInfo = { text: \"💊\", ctx: { fillStyle: \"#2671FF\", strokeStyle: \"white\" } };\n      return prefabInfo;\n    } else if (pfName.includes(\"book\")) {\n      prefabInfo = { text: \"📖\", ctx: { fillStyle: \"#44F3FF\", strokeStyle: \"#147178\" } };\n      return prefabInfo;\n    } else {\n      return prefabInfo;\n    }\n  }\n\n  private drawPrefabs(ctx: OffscreenCanvasRenderingContext2D, width: number, height: number) {\n    const offsetX = width / 2;\n    const offsetY = height / 2;\n\n    const charOffsetX = Math.round(this.signSize * 0.01);\n    const charOffsetY = Math.round(this.signSize * 0.05);\n    const toolOffsetX = Math.round(this.signSize * 0.05);\n    const toolOffsetY = Math.round(this.signSize * 0.05);\n\n    // Inverted iteration to overwrite signs by higher order prefabs\n    for (let i = this.prefabs.length - 1; i >= 0; i -= 1) {\n      const prefab = this.prefabs[i];\n      const x = offsetX + prefab.x + charOffsetX;\n      const xT = offsetX + prefab.x + toolOffsetX;\n      // prefab vertical positions are inverted for canvas coodinates\n      const z = offsetY - prefab.z + charOffsetY;\n      const zT = offsetY - prefab.z + toolOffsetY - 80;\n\n      const prefabInfo = this.customizeSignByPrefabCategory(prefab);\n\n      ctx.font = `${this.signSize}px ${this.fontFace?.family ?? \"\"}`;\n      ctx.fillStyle = prefabInfo.ctx.fillStyle;\n      ctx.strokeStyle = prefabInfo.ctx.strokeStyle;\n      ctx.textAlign = \"center\";\n      ctx.textBaseline = \"middle\";\n      putText(ctx, { text: prefabInfo.text, x, z, size: this.signSize });\n      if (this.showToolTips) {\n        ctx.font = `${this.signSize}px ${this.toolTipFontFace?.family ?? \"\"}`;\n        putToolTipText(ctx, { text: prefab.name, xT, zT, sizeT: this.toolTipSize });\n      }\n    }\n  }\n\n  private drawMark(ctx: OffscreenCanvasRenderingContext2D, width: number, height: number) {\n    if (!this.markerCoords) return;\n\n    ctx.font = `${this.markerSize}px ${this.fontFace?.family ?? \"\"}`;\n    ctx.fillStyle = \"red\";\n    ctx.shadowOffsetX = 3;\n    ctx.shadowOffsetY = -2;\n    ctx.shadowBlur = 5;\n    ctx.strokeStyle = \"#830000\";\n    ctx.shadowColor = \"rgba(75,75,75,0.75)\";\n    ctx.textAlign = \"left\";\n    ctx.textBaseline = \"alphabetic\";\n\n    const offsetX = width / 2;\n    const offsetY = height / 2;\n    const charOffsetX = -1 * Math.round(this.markerSize * 0.32);\n    const charOffsetY = -1 * Math.round(this.markerSize * 0.1);\n\n    const x = offsetX + this.markerCoords.x + charOffsetX;\n    const z = offsetY - this.markerCoords.z + charOffsetY;\n\n    putText(ctx, { text: MARK_CHAR, x, z, size: this.markerSize });\n    ctx.fillText(MARK_CHAR, x, z);\n  }\n}\n\ninterface MapSign {\n  text: string;\n  x: number;\n  z: number;\n  size: number;\n}\n\ninterface ToolTipSign {\n  text: string;\n  xT: number;\n  zT: number;\n  sizeT: number;\n}\n\nfunction putText(ctx: OffscreenCanvasRenderingContext2D, { text, x, z, size }: MapSign) {\n  ctx.lineWidth = Math.round(size * 0.2);\n  ctx.strokeText(text, x, z);\n\n  ctx.lineWidth = Math.round(size * 0.1);\n  ctx.strokeText(text, x, z);\n\n  ctx.fillText(text, x, z);\n}\n\nfunction putToolTipText(ctx: OffscreenCanvasRenderingContext2D, { text, xT, zT, sizeT }: ToolTipSign) {\n  ctx.lineWidth = Math.round(sizeT * 0.2);\n\n  ctx.lineWidth = Math.round(sizeT * 0.05);\n  ctx.strokeText(text, xT, zT);\n\n  ctx.fillText(text, xT, zT);\n}\n","import { waitAnimationFrame } from \"./utils\";\n\nexport function throttledInvoker(asyncFunc: () => Promise<void> | void): () => Promise<void> {\n  const workerPromises: Promise<void>[] = [];\n  return () => {\n    switch (workerPromises.length) {\n      case 0: {\n        workerPromises.push(\n          (async () => {\n            await asyncFunc();\n            workerPromises.shift();\n          })()\n        );\n        return workerPromises[0];\n      }\n      case 1: {\n        const prev = workerPromises[0];\n        workerPromises.push(\n          (async () => {\n            await prev;\n            await waitAnimationFrame();\n            await asyncFunc();\n            workerPromises.shift();\n          })()\n        );\n        return workerPromises[1];\n      }\n      case 2:\n        return workerPromises[1];\n      default:\n        throw Error(`Unexpected state: promiceses=${workerPromises.length}`);\n    }\n  };\n}\n","export function requireNonnull<T>(t: T | undefined | null, message = () => `Unexpected state: ${t}`): T {\n  if (t != null) return t;\n  else throw Error(message());\n}\n\nexport function requireType<T>(o: unknown, t: { new (...a: unknown[]): T }, message = () => `Unexpected type: ${o}`): T {\n  if (o instanceof t) return o;\n  throw Error(message());\n}\n\nexport function component<T extends HTMLElement = HTMLElement>(id: string | null | undefined, t?: { new (...a: unknown[]): T }): T {\n  const e = requireNonnull(\n    document.getElementById(requireNonnull(id, () => `Element ID must not null: ${id}`)),\n    () => `Element not found: #${id}`\n  );\n  return t ? requireType(e, t) : (e as T);\n}\n\nexport function removeAllChildren(e: HTMLElement): void {\n  while (e.lastChild) e.removeChild(e.lastChild);\n}\n\nexport function humanreadableDistance(d: number): string {\n  if (d < 1000) {\n    return `${d}m`;\n  }\n  return `${(d / 1000).toFixed(2)}km`;\n}\n\nexport function waitAnimationFrame(): Promise<number> {\n  return new Promise((r) => requestAnimationFrame(r));\n}\n\ninterface EventOffsets {\n  offsetX: number;\n  offsetY: number;\n}\n\nexport function sendCoords(\n  map: GameMapSize,\n  canvas: HTMLCanvasElement,\n  elevation: (coods: GameCoords, mapSize: GameMapSize) => number | null,\n  event: EventOffsets | null\n): { x: number | string; z: number | string; y: number | string } {\n  if (!event) return { x: \"-\", z: \"-\", y: \"-\" };\n\n  const gameCoords = canvasEventToGameCoords(event, map, canvas);\n  if (gameCoords === null) {\n    return { x: \"-\", z: \"-\", y: \"-\" };\n  }\n\n  const y = elevation(gameCoords, map) ?? \"-\";\n  return { x: gameCoords.x, z: gameCoords.z, y };\n}\n\nexport function downloadCanvasPng(fileName: string, canvas: HTMLCanvasElement): void {\n  const a = document.createElement(\"a\");\n  a.download = fileName;\n  a.href = canvas.toDataURL(\"image/png\");\n  a.click();\n}\n\nexport async function imageBitmapToPngBlob(img: ImageBitmap): Promise<PngBlob> {\n  const canvas = new OffscreenCanvas(img.height, img.width);\n  const context = requireNonnull(canvas.getContext(\"2d\"));\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  context.drawImage(img, 0, 0);\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  return (await canvas.convertToBlob({ type: \"image/png\" })) as PngBlob;\n}\n\nexport async function sleep(msec: number): Promise<void> {\n  return new Promise((r) => setTimeout(r, msec));\n}\n\nexport function gameMapSize(s: { width: number; height: number }): GameMapSize {\n  return { type: \"game\", ...s };\n}\n\nexport function gameCoords(c: { x: number; z: number }): GameCoords {\n  return { type: \"game\", ...c };\n}\n\n/** Returns null if the event was fired out of the canvas */\nexport function canvasEventToGameCoords(event: EventOffsets, mapSize: GameMapSize, canvasSize: HTMLCanvasElement): GameCoords | null {\n  // in-game scale coords with left-top offset\n  const gx = (event.offsetX * mapSize.width) / canvasSize.width;\n  const gz = (event.offsetY * mapSize.height) / canvasSize.height;\n  if (gx < 0 || gx >= mapSize.width || gz < 0 || gz >= mapSize.height) {\n    return null;\n  }\n\n  // in-game coords (center offset)\n  const x = gx - Math.floor(mapSize.width / 2);\n  const z = Math.floor(mapSize.height / 2) - gz;\n  return gameCoords({ x: Math.round(x), z: Math.round(z) });\n}\n\nexport function threePlaneSize(width: number, height: number): ThreePlaneSize {\n  return { type: \"threePlane\", width, height };\n}\n","import { FontFaceSet } from \"css-font-loading-module\";\nimport MapRenderer from \"../lib/map-renderer\";\n\ndeclare const fonts: FontFaceSet;\n\nexport type InMessage = Partial<\n  Pick<\n    MapRenderer,\n    | \"canvas\"\n    | \"biomesImg\"\n    | \"splat3Img\"\n    | \"splat4Img\"\n    | \"radImg\"\n    | \"biomesAlpha\"\n    | \"splat3Alpha\"\n    | \"splat4Alpha\"\n    | \"radAlpha\"\n    | \"showPrefabs\"\n    | \"brightness\"\n    | \"scale\"\n    | \"signSize\"\n    | \"signAlpha\"\n    | \"prefabs\"\n    | \"markerCoords\"\n  >\n>;\n\nexport interface OutMessage {\n  mapSize: GameMapSize;\n}\n\ndeclare function postMessage(message: OutMessage): void;\n\nconst FONT_FACE = new FontFace(\"Noto Emoji\", \"url(../NotoEmoji-Regular.ttf)\");\nconst TOOLTIP_FONT_FACE = new FontFace(\"Heebo Medium\", \"url(../Heebo-Medium.ttf)\");\n\nlet map: MapRenderer | null = null;\n\nFONT_FACE.load()\n  .then(() => {\n    fonts.add(FONT_FACE);\n  })\n  .then(() => {\n    TOOLTIP_FONT_FACE.load();\n  })\n  .then(() => {\n    fonts.add(TOOLTIP_FONT_FACE);\n    map?.update();\n  });\n\nonmessage = async (event: MessageEvent<InMessage>) => {\n  const message = event.data;\n  console.debug(message);\n  if (!map) {\n    if (message.canvas) {\n      map = new MapRenderer(message.canvas, FONT_FACE, TOOLTIP_FONT_FACE);\n    } else {\n      throw Error(\"Unexpected state\");\n    }\n  }\n  await Object.assign(map, message).update();\n  postMessage({ mapSize: await map.size() });\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(179);\n"],"names":["constructor","label","original","imgAge","fallbackPromise","lastAccessAt","this","Blob","_png","imageBitmapToPngBlob","setImg","async","Date","now","img","getFallback","getImageBitmap","console","debug","createImageBitmap","setTimeout","expireImage","requireNonnull","close","putText","ctx","text","x","z","size","lineWidth","Math","round","strokeText","fillText","putToolTipText","xT","zT","sizeT","canvas","fontFace","toolTipFontFace","brightness","markerCoords","scale","showPrefabs","showToolTips","prefabs","signSize","markerSize","toolTipSize","signAlpha","biomesAlpha","splat3Alpha","splat4Alpha","radAlpha","update","throttledInvoker","time","updateImmediately","timeEnd","_biomesImg","_splat3Img","_splat4Img","_radImg","biomesImg","ImageBitmapHolder","splat3Img","splat4Img","radImg","rects","Promise","all","get","gameMapSize","width","max","map","r","height","isBlank","context","getContext","filter","globalAlpha","drawImage","imageSmoothingEnabled","drawPrefabs","drawMark","customizeSignByPrefabCategory","prefab","pfName","name","toLocaleLowerCase","prefabInfo","fillStyle","strokeStyle","includes","offsetX","offsetY","charOffsetX","charOffsetY","toolOffsetX","toolOffsetY","i","length","font","family","textAlign","textBaseline","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","asyncFunc","workerPromises","push","shift","prev","waitAnimationFrame","Error","t","message","requireType","o","gameCoords","c","type","canvasEventToGameCoords","event","mapSize","canvasSize","gx","gz","floor","id","e","document","getElementById","lastChild","removeChild","d","toFixed","requestAnimationFrame","elevation","y","fileName","a","createElement","download","href","toDataURL","click","OffscreenCanvas","convertToBlob","msec","s","FONT_FACE","FontFace","TOOLTIP_FONT_FACE","load","then","fonts","add","onmessage","data","Object","assign","postMessage","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","call"],"sourceRoot":""}