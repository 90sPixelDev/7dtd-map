(()=>{"use strict";var t={17:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0});const n=s(847);function r(t,e){return t.name>e.name?1:t.name<e.name?-1:0}function a(t,e){return t.dist&&e.dist?t.dist>e.dist?1:t.dist<e.dist?-1:r(t,e):r(t,e)}function i(t,e){let s=!1;const n=t.replace(e,(t=>(s=t.length>0,`<mark>${t}</mark>`)));return s?n:null}e.default=class{constructor(){this.all=[],this.blockLabels={},this.blockPrefabIndex={},this.filter=null,this.filtered=[],this.markCoords=null,this.status="",this.throttledUpdater=n.throttledInvoker((async()=>this.updateImmediately())),this.updateListeners=[]}update(){this.throttledUpdater()}updateImmediately(){this.applyFilter(),this.updateDist(),this.sort();const t={status:this.status,prefabs:this.filtered};this.updateListeners.forEach((e=>e(t)))}set prefabsFilterString(t){const e=t.trim();0===e.length?this.filter=null:this.filter=new o(new RegExp(e,"i"))}set blocksFilterString(t){const e=t.trim();0===e.length?this.filter=null:this.filter=new l(new RegExp(e,"i"),this.blockPrefabIndex,this.blockLabels)}addUpdateListener(t){this.updateListeners.push(t)}applyFilter(){if(this.filter){const t=this.filter.match(this.all);this.status=t.status,this.filtered=t.matched}else 0===this.all.length?(this.status="No prefabs",this.filtered=[]):(this.status="All prefabs",this.filtered=this.all)}updateDist(){if(this.markCoords){const{markCoords:t}=this;this.filtered.forEach((e=>{return e.dist=(s=e,n=t,Math.round(Math.sqrt((s.x-n.x)**2+(s.z-n.z)**2)));var s,n}))}else this.filtered.forEach((t=>t.dist=null))}sort(){this.markCoords?(this.status=`${this.status}, order by distances from the flag`,this.filtered.sort(a)):this.filtered.sort(r)}};class o{constructor(t){this.regexp=t}match(t){const e=t.flatMap((t=>{const e=i(t.name,this.regexp);return e?{...t,highlightedName:e}:[]}));return{status:`${e.length} matched prefabs`,matched:e}}}class l{constructor(t,e,s){this.regexp=t,this.blockPrefabIndex=e,this.blockLabels=s}match(t){const e=this.matchBlocks();if(0===e.length)return{status:"No matched blocks",matched:[]};const s=this.matchPrefabTypes(e);if(0===Object.keys(s).length)return{status:`No prefabs, ${e.length} matched blocks`,matched:[]};const n=t.flatMap((t=>{const e=s[t.name];return e?{...t,matchedBlocks:e}:[]}));return{status:`${n.length} prefabs, ${e.length} matched blocks`,matched:n}}matchBlocks(){return Object.entries(this.blockPrefabIndex).reduce(((t,[e,s])=>{const n=i(e,this.regexp),r=this.blockLabels[e],a=r&&i(r,this.regexp);return n||a?t.concat({name:e,highlightedName:n||e,highlightedLabel:a||r,prefabs:s}):t}),[])}matchPrefabTypes(t){return t.reduce(((t,e)=>{const{name:s,highlightedName:n,highlightedLabel:r}=e;return e.prefabs?.forEach((e=>{const a={name:s,highlightedName:n,highlightedLabel:r,count:e.count};t[e.name]=(t[e.name]||[]).concat(a)})),t}),{})}}},847:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.throttledInvoker=void 0;const n=s(726);e.throttledInvoker=function(t){const e=[];return()=>{switch(e.length){case 0:return e.push((async()=>{await t(),e.shift()})()),e[0];case 1:const s=e[0];return e.push((async()=>{await s,await n.waitAnimationFrame(),await t(),e.shift()})()),e[1];case 2:return e[1];default:throw Error(`Unexpected state: promiceses=${e.length}`)}}}},726:(t,e)=>{function s(t,e=(()=>`Unexpected state: ${t}`)){if(null!=t)return t;throw Error(e())}function n(t,e,s=(()=>`Unexpected type: ${t}`)){if(t instanceof e)return t;throw Error(s())}function r(t){return{type:"game",...t}}function a(t,e,s){const n=t.offsetX*e.width/s.width,a=t.offsetY*e.height/s.height;if(n<0||n>=e.width||a<0||a>=e.height)return null;const i=n-Math.floor(e.width/2),o=Math.floor(e.height/2)-a;return r({x:Math.round(i),z:Math.round(o)})}Object.defineProperty(e,"__esModule",{value:!0}),e.canvasEventToGameCoords=e.gameCoords=e.gameMapSize=e.sleep=e.imageBitmapToPngBlob=e.downloadCanvasPng=e.formatCoords=e.waitAnimationFrame=e.humanreadableDistance=e.removeAllChildren=e.component=e.requireType=e.requireNonnull=void 0,e.requireNonnull=s,e.requireType=n,e.component=function(t,e){const r=s(document.getElementById(s(t,(()=>`Element ID must not null: ${t}`))),(()=>`Element not found: #${t}`));return e?n(r,e):r},e.removeAllChildren=function(t){for(;t.lastChild;)t.removeChild(t.lastChild)},e.humanreadableDistance=function(t){return t<1e3?`${t}m`:`${(t/1e3).toFixed(2)}km`},e.waitAnimationFrame=function(){return new Promise((t=>requestAnimationFrame(t)))},e.formatCoords=function(t,e,s,n){if(!n)return"E/W: -, N/S: -, Elev: -";const r=a(n,t,e);if(null===r)return"E/W: -, N/S: -, Elev: -";const i=s(r,t)??"-";return`E/W: ${r.x}, N/S: ${r.z}, Elev: ${i}`},e.downloadCanvasPng=function(t,e){const s=document.createElement("a");s.download=t,s.href=e.toDataURL("image/png"),s.click()},e.imageBitmapToPngBlob=async function(t){const e=new OffscreenCanvas(t.height,t.width);return s(e.getContext("2d")).drawImage(t,0,0),await e.convertToBlob({type:"image/png"})},e.sleep=async function(t){return new Promise((e=>setTimeout(e,t)))},e.gameMapSize=function(t){return{type:"game",...t}},e.gameCoords=r,e.canvasEventToGameCoords=a},770:function(t,e,s){var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const r=new(n(s(17)).default);fetch("../block-prefab-index.json").then((async t=>r.blockPrefabIndex=await t.json())),fetch("../block-labels.json").then((async t=>r.blockLabels=await t.json())),onmessage=({data:t})=>{Object.assign(r,t).update()},r.addUpdateListener((t=>postMessage(t)))}},e={};!function s(n){var r=e[n];if(void 0!==r)return r.exports;var a=e[n]={exports:{}};return t[n].call(a.exports,a,a.exports,s),a.exports}(770)})();
//# sourceMappingURL=prefabs-filter.js.map