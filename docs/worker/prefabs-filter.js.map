{"version":3,"sources":["webpack://7dtd-map/./src/lib/prefabs.ts","webpack://7dtd-map/./src/lib/throttled-invoker.ts","webpack://7dtd-map/./src/lib/utils.ts","webpack://7dtd-map/./src/worker/prefabs-filter.ts","webpack://7dtd-map/webpack/bootstrap","webpack://7dtd-map/webpack/startup"],"names":["nameSorter","a","b","name","distSorter","dist","filterByPrefabs","prefabs","pattern","results","all","flatMap","prefab","m","matchAndHighlight","highlightedName","status","length","filterByBlocks","allPrefabs","blockPrefabIndex","blockLabels","matchedBlocks","Object","entries","reduce","arr","blockName","blockLabel","highlightedLabel","concat","matchBlocks","matchedPrefabBlocks","idx","block","forEach","p","count","matchPrefabTypes","keys","blocks","str","regex","isMatched","highlighted","replace","this","filtered","filter","prefabsFilterString","blocksFilterString","markCoords","updateListeners","throttledUpdater","async","updateImmediately","map","func","targetCoords","baseCoords","Math","round","sqrt","x","z","sort","update","f","s","trim","RegExp","push","asyncFunc","updateRequest","workerPromise","waitAnimationFrame","requireNonnull","t","message","Error","requireType","o","id","e","document","getElementById","lastChild","removeChild","d","toFixed","Promise","r","requestAnimationFrame","canvas","elevation","event","gx","offsetX","width","gz","offsetY","height","fileName","createElement","download","href","toDataURL","click","img","OffscreenCanvas","getContext","drawImage","convertToBlob","type","fetch","then","json","onmessage","data","assign","addUpdateListener","u","postMessage","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","call"],"mappings":"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","file":"worker/prefabs-filter.js","sourcesContent":["import throttledInvoker from \"./throttled-invoker\";\n\ndeclare interface PrefabFilter {\n  name: string;\n  func: (prefabs: Prefabs, pattern: RegExp) => HighlightedPrefab[];\n  pattern: RegExp;\n}\n\nexport declare interface PrefabUpdate {\n  status: string;\n  prefabs: HighlightedPrefab[];\n}\n\ndeclare interface PrefabHighlightedBlocks {\n  [prefabName: string]: HighlightedBlock[];\n}\n\nexport default class Prefabs {\n  all: Prefab[];\n  blockLabels: BlockLabels;\n  blockPrefabIndex: BlockPrefabIndex;\n  filter: PrefabFilter | null;\n  filtered: HighlightedPrefab[];\n  throttledUpdater: () => void;\n  markCoords: Coords | null;\n  status: string;\n  updateListeners: ((u: PrefabUpdate) => void)[];\n\n  constructor() {\n    this.all = [];\n    this.filtered = [];\n    this.filter = null;\n    this.prefabsFilterString = \"\";\n    this.blocksFilterString = \"\";\n    this.markCoords = null;\n    this.blockPrefabIndex = {};\n    this.blockLabels = {};\n    this.updateListeners = [];\n    this.status = \"\";\n    this.throttledUpdater = throttledInvoker(async () => this.updateImmediately());\n  }\n  update(): void {\n    this.throttledUpdater();\n  }\n  updateImmediately(): void {\n    applyFilter(this);\n    updateDist(this);\n    sort(this);\n    const update: PrefabUpdate = { status: this.status, prefabs: this.filtered };\n    this.updateListeners.forEach((f) => f(update));\n  }\n  set prefabsFilterString(filter: string) {\n    const s = filter.trim();\n    if (s.length === 0) {\n      this.filter = null;\n    } else {\n      this.filter = {\n        name: \"prefab name\",\n        func: filterByPrefabs,\n        pattern: new RegExp(s, \"i\"),\n      };\n    }\n  }\n  set blocksFilterString(filter: string) {\n    const s = filter.trim();\n    if (s.length === 0) {\n      this.filter = null;\n    } else {\n      this.filter = {\n        name: \"block name\",\n        func: filterByBlocks,\n        pattern: new RegExp(s, \"i\"),\n      };\n    }\n  }\n  addUpdateListener(func: (update: PrefabUpdate) => void): void {\n    this.updateListeners.push(func);\n  }\n}\nfunction applyFilter(prefabs: Prefabs) {\n  if (prefabs.filter) {\n    prefabs.filtered = prefabs.filter.func(prefabs, prefabs.filter.pattern);\n  } else {\n    if (prefabs.all.length === 0) {\n      prefabs.status = \"No prefabs\";\n    } else {\n      prefabs.status = \"All prefabs\";\n    }\n    prefabs.filtered = prefabs.all;\n  }\n}\nfunction updateDist(map: Prefabs) {\n  if (map.markCoords) {\n    map.filtered.forEach((p) => (p.dist = calcDist(p, map.markCoords as Coords)));\n  } else {\n    map.filtered.forEach((p) => (p.dist = null));\n  }\n}\nfunction sort(prefabs: Prefabs) {\n  if (prefabs.markCoords) {\n    prefabs.filtered.sort(distSorter);\n  } else {\n    prefabs.filtered.sort(nameSorter);\n  }\n}\nfunction nameSorter(a: { name: string }, b: { name: string }) {\n  if (a.name > b.name) return 1;\n  if (a.name < b.name) return -1;\n  return 0;\n}\nfunction distSorter(a: HighlightedPrefab, b: HighlightedPrefab) {\n  if (!a.dist || !b.dist) return nameSorter(a, b);\n  if (a.dist > b.dist) return 1;\n  if (a.dist < b.dist) return -1;\n  return 0;\n}\nfunction filterByPrefabs(prefabs: Prefabs, pattern: RegExp) {\n  const results = prefabs.all.flatMap((prefab) => {\n    const m = matchAndHighlight(prefab.name, pattern);\n    if (m) {\n      // Clone and add a new field;\n      return { ...prefab, highlightedName: m };\n    }\n    return [];\n  });\n  prefabs.status = `${results.length} matched prefabs`;\n  return results;\n}\nfunction filterByBlocks(prefabs: Prefabs, pattern: RegExp) {\n  const { all: allPrefabs, blockPrefabIndex, blockLabels } = prefabs;\n  const matchedBlocks = matchBlocks(pattern, blockPrefabIndex, blockLabels);\n  if (matchedBlocks.length === 0) {\n    prefabs.status = \"No matched blocks\";\n    return [];\n  }\n  const matchedPrefabBlocks = matchPrefabTypes(matchedBlocks);\n  if (Object.keys(matchedPrefabBlocks).length === 0) {\n    prefabs.status = `No prefabs, ${matchedBlocks.length} matched blocks`;\n    return [];\n  }\n  const results = allPrefabs.flatMap((prefab: Prefab) => {\n    const blocks = matchedPrefabBlocks[prefab.name];\n    if (!blocks) {\n      return [];\n    }\n    // Clone and add a new field;\n    return { ...prefab, matchedBlocks: blocks };\n  });\n  prefabs.status = `${results.length} prefabs, ${matchedBlocks.length} matched blocks`;\n  return results;\n}\n\nfunction matchPrefabTypes(matchedBlocks: HighlightedBlock[]): PrefabHighlightedBlocks {\n  return matchedBlocks.reduce<PrefabHighlightedBlocks>((idx, block) => {\n    const { name, highlightedName, highlightedLabel } = block;\n    block.prefabs?.forEach((p) => {\n      const b = {\n        name,\n        highlightedName,\n        highlightedLabel,\n        count: p.count,\n      };\n      idx[p.name] = (idx[p.name] || []).concat(b);\n    });\n    return idx;\n  }, {});\n}\n\nfunction matchBlocks(pattern: RegExp, blockPrefabIndex: BlockPrefabIndex, blockLabels: BlockLabels) {\n  return (Object.entries(blockPrefabIndex) as [string, { name: string; count: number }[]][]).reduce<HighlightedBlock[]>(\n    (arr, [blockName, prefabs]) => {\n      const highlightedName = matchAndHighlight(blockName, pattern);\n      const blockLabel = blockLabels[blockName];\n      const highlightedLabel = blockLabel && matchAndHighlight(blockLabel, pattern);\n      if (highlightedName || highlightedLabel) {\n        return arr.concat({\n          name: blockName,\n          highlightedName: highlightedName || blockName,\n          highlightedLabel: highlightedLabel || blockLabel,\n          prefabs,\n        });\n      }\n      return arr;\n    },\n    []\n  );\n}\nfunction calcDist(targetCoords: Coords, baseCoords: Coords) {\n  return Math.round(Math.sqrt((targetCoords.x - baseCoords.x) ** 2 + (targetCoords.z - baseCoords.z) ** 2));\n}\nfunction matchAndHighlight(str: string, regex: RegExp) {\n  let isMatched = false;\n  const highlighted = str.replace(regex, (m) => {\n    isMatched = m.length > 0;\n    return `<mark>${m}</mark>`;\n  });\n  return isMatched ? highlighted : null;\n}\n","import { waitAnimationFrame } from \"./utils\";\n\nexport default function throttledInvoker(asyncFunc: () => Promise<void>): () => Promise<void> {\n  let updateRequest = false;\n  let workerPromise: Promise<void> | null = null;\n  return async () => {\n    updateRequest = true;\n\n    if (workerPromise) {\n      return;\n    }\n\n    workerPromise = (async () => {\n      while (updateRequest) {\n        updateRequest = false;\n        await asyncFunc();\n        await waitAnimationFrame();\n      }\n      workerPromise = null;\n    })();\n  };\n}\n","export function requireNonnull<T>(t: T | undefined | null, message = () => `Unexpected state: ${t}`): T {\n  if (t) return t;\n  else throw Error(message());\n}\n\nexport function requireType<T>(o: unknown, t: { new (...a: unknown[]): T }, message = () => `Unexpected type: ${o}`): T {\n  if (o instanceof t) return o;\n  throw Error(message());\n}\n\nexport function component<T extends HTMLElement = HTMLElement>(id: string | null | undefined, t?: { new (...a: unknown[]): T }): T {\n  const e = requireNonnull(\n    document.getElementById(requireNonnull(id, () => `Element ID must not null: ${id}`)),\n    () => `Element not found: #${id}`\n  );\n  return t ? requireType(e, t) : (e as T);\n}\n\nexport function removeAllChildren(e: HTMLElement): void {\n  while (e.lastChild) e.removeChild(e.lastChild);\n}\n\nexport function humanreadableDistance(d: number): string {\n  if (d < 1000) {\n    return `${d}m`;\n  }\n  return `${(d / 1000).toFixed(2)}km`;\n}\n\nexport function waitAnimationFrame(): Promise<number> {\n  return new Promise((r) => requestAnimationFrame(r));\n}\n\ninterface EventOffsets {\n  offsetX: number;\n  offsetY: number;\n}\n\nexport function formatCoords(\n  map: RectSize,\n  canvas: RectSize,\n  elevation: (coods: Coords, width: number) => number | null,\n  event: EventOffsets | null\n): string {\n  if (!event) return \"E/W: -, N/S: -, Elev: -\";\n\n  // in-game scale coords with left-top offset\n  const gx = (event.offsetX * map.width) / canvas.width;\n  const gz = (event.offsetY * map.height) / canvas.height;\n  if (gx < 0 || gx >= map.width || gz < 0 || gz >= map.height) {\n    return \"E/W: -, N/S: -, Elev: -\";\n  }\n\n  // in-game coords (center offset)\n  const x = Math.round(gx - map.width / 2);\n  const z = Math.round(map.height / 2 - gz);\n  const e = elevation({ x: Math.round(gx), z: Math.round(gz) }, map.width) ?? \"-\";\n  return `E/W: ${x}, N/S: ${z}, Elev: ${e}`;\n}\n\nexport function downloadCanvasPng(fileName: string, canvas: HTMLCanvasElement): void {\n  const a = document.createElement(\"a\");\n  a.download = fileName;\n  a.href = canvas.toDataURL(\"image/png\");\n  a.click();\n}\n\nexport async function imageBitmapToPngBlob(img: ImageBitmap): Promise<PngBlob> {\n  const canvas = new OffscreenCanvas(img.height, img.width);\n  const context = requireNonnull(canvas.getContext(\"2d\"));\n  context.drawImage(img, 0, 0);\n  return (await canvas.convertToBlob({ type: \"image/png\" })) as PngBlob;\n}\n","import Prefabs from \"../lib/prefabs\";\n\nexport type PrefabsFilterInMessage = Partial<Pick<Prefabs, \"all\" | \"prefabsFilterString\" | \"blocksFilterString\" | \"markCoords\">>;\n\nconst prefabs = new Prefabs();\nfetch(\"../block-prefab-index.json\").then(async (r) => (prefabs.blockPrefabIndex = await r.json()));\nfetch(\"../block-labels.json\").then(async (r) => (prefabs.blockLabels = await r.json()));\n\nonmessage = ({ data }) => {\n  Object.assign(prefabs, data as PrefabsFilterInMessage).update();\n};\n\nprefabs.addUpdateListener((u) => postMessage(u));\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(770);\n"],"sourceRoot":""}