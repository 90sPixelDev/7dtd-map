(()=>{"use strict";var t={934:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ImageBitmapHolder=void 0;const s=i(726);e.ImageBitmapHolder=class{constructor(t,e,i=1e4){this.fallbackPromise=null,this.lastAccessAt=0,this.label=t,e instanceof Blob?this._png=e:(this._png=(0,s.imageBitmapToPngBlob)(e),this.setImg(e)),this.imgAge=i}async get(){return this.lastAccessAt=Date.now(),this.img??this.fallbackPromise??this.getFallback()}async getFallback(){return this.fallbackPromise=this.getImageBitmap(),this.fallbackPromise}async getImageBitmap(){console.debug("Fallback",this.label);const t=await createImageBitmap(await this._png);return this.setImg(t),this.fallbackPromise=null,t}setImg(t){this.img=t,setTimeout((()=>this.expireImage()),this.imgAge)}expireImage(){Date.now()-this.lastAccessAt>this.imgAge?(console.debug("Expire",this.label),(0,s.requireNonnull)(this.img).close(),this.img=null):setTimeout((()=>this.expireImage()),this.imgAge)}}},902:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0});const s=i(934),a=i(847),l=i(726);function n(t,{text:e,x:i,z:s,size:a}){t.lineWidth=Math.round(.2*a),t.strokeText(e,i,s),t.lineWidth=Math.round(.1*a),t.strokeText(e,i,s),t.fillText(e,i,s)}function o(t,{text:e,xT:i,zT:s,sizeT:a}){t.lineWidth=Math.round(.2*a),t.lineWidth=Math.round(.05*a),t.strokeText(e,i,s),t.fillText(e,i,s)}e.default=class{constructor(t,e,i){this.brightness="100%",this.markerCoords=null,this.scale=.1,this.showPrefabs=!0,this.showToolTips=!1,this.prefabs=[],this.signSize=200,this.markerSize=100,this.toolTipSize=300,this.signAlpha=1,this.biomesAlpha=1,this.splat3Alpha=1,this.splat4Alpha=1,this.radAlpha=1,this.update=(0,a.throttledInvoker)((async()=>{console.time("MapUpdate"),await this.updateImmediately(),console.timeEnd("MapUpdate")})),this._biomesImg=null,this._splat3Img=null,this._splat4Img=null,this._radImg=null,this.canvas=t,this.fontFace=e,this.toolTipFontFace=i}set biomesImg(t){this._biomesImg=t?new s.ImageBitmapHolder("biomes",t):null}set splat3Img(t){this._splat3Img=t?new s.ImageBitmapHolder("splat3",t):null}set splat4Img(t){this._splat4Img=t?new s.ImageBitmapHolder("splat4",t):null}set radImg(t){this._radImg=t?new s.ImageBitmapHolder("rad",t):null}async size(){const t=await Promise.all([this._biomesImg?.get(),this._splat3Img?.get(),this._splat4Img?.get()]);return(0,l.gameMapSize)({width:Math.max(...t.map((t=>t?.width??0))),height:Math.max(...t.map((t=>t?.height??0)))})}isBlank(){return!this._biomesImg&&!this._splat3Img&&!this._splat4Img}async updateImmediately(){if(this.isBlank())return this.canvas.width=1,void(this.canvas.height=1);const{width:t,height:e}=await this.size();this.canvas.width=t*this.scale,this.canvas.height=e*this.scale;const i=this.canvas.getContext("2d");i&&(i.scale(this.scale,this.scale),i.filter=`brightness(${this.brightness})`,this._biomesImg&&0!==this.biomesAlpha&&(i.globalAlpha=this.biomesAlpha,i.drawImage(await this._biomesImg.get(),0,0,t,e)),this._splat3Img&&0!==this.splat3Alpha&&(i.globalAlpha=this.splat3Alpha,i.drawImage(await this._splat3Img.get(),0,0,t,e)),this._splat4Img&&0!==this.splat4Alpha&&(i.globalAlpha=this.splat4Alpha,i.drawImage(await this._splat4Img.get(),0,0,t,e)),i.filter="none",this._radImg&&0!==this.radAlpha&&(i.globalAlpha=this.radAlpha,i.imageSmoothingEnabled=!1,i.drawImage(await this._radImg.get(),0,0,t,e),i.imageSmoothingEnabled=!0),i.globalAlpha=this.signAlpha,this.showPrefabs&&this.drawPrefabs(i,t,e),this.markerCoords&&this.drawMark(i,t,e))}customizeSignByPrefabCategory(t){const e=t.name.toLocaleLowerCase();let i={text:"❌",ctx:{fillStyle:"white",strokeStyle:"#000"}};return e.includes("filler")?(i={text:"🔶",ctx:{fillStyle:"gray",strokeStyle:"#1C2F51"}},i):e.includes("part")&&!e.includes("apartment")?(i={text:"",ctx:{fillStyle:"#576D98",strokeStyle:"#374869"}},i):e.includes("gas")?(i={text:"⛽",ctx:{fillStyle:"red",strokeStyle:"#5E1616"}},i):e.includes("trader")&&!e.includes("filler")?(i={text:"💰",ctx:{fillStyle:"yellow",strokeStyle:"#A47D00"}},i):e.includes("sham")?(i={text:"🥫",ctx:{fillStyle:"yellow",strokeStyle:"white"}},i):e.includes("farm")||e.includes("barn")?(i={text:"🚜",ctx:{fillStyle:"orange",strokeStyle:"#704D17"}},i):e.includes("survivor")?(i={text:"👤",ctx:{fillStyle:"purple",strokeStyle:"#17072C"}},i):e.includes("skyscraper")&&!e.includes("filler")?(i={text:"🏢",ctx:{fillStyle:"#8FA5CF",strokeStyle:"#1C2F51"}},i):e.includes("hospital")||e.includes("clinic")||e.includes("pharmacy")?(i={text:"💊",ctx:{fillStyle:"#2671FF",strokeStyle:"white"}},i):e.includes("book")?(i={text:"📖",ctx:{fillStyle:"#44F3FF",strokeStyle:"#147178"}},i):i}drawPrefabs(t,e,i){const s=e/2,a=i/2,l=Math.round(.01*this.signSize),r=Math.round(.05*this.signSize),h=Math.round(.05*this.signSize),c=Math.round(.05*this.signSize);for(let e=this.prefabs.length-1;e>=0;e-=1){const i=this.prefabs[e],m=s+i.x+l,d=s+i.x+h,u=a-i.z+r,g=a-i.z+c-80,p=this.customizeSignByPrefabCategory(i);t.font=`${this.signSize}px ${this.fontFace?.family??""}`,t.fillStyle=p.ctx.fillStyle,t.strokeStyle=p.ctx.strokeStyle,t.textAlign="center",t.textBaseline="middle",n(t,{text:p.text,x:m,z:u,size:this.signSize}),this.showToolTips&&(t.font=`${this.signSize}px ${this.toolTipFontFace?.family??""}`,o(t,{text:i.name,xT:d,zT:g,sizeT:this.toolTipSize}))}}drawMark(t,e,i){if(!this.markerCoords)return;t.font=`${this.markerSize}px ${this.fontFace?.family??""}`,t.fillStyle="red",t.shadowOffsetX=3,t.shadowOffsetY=-2,t.shadowBlur=5,t.strokeStyle="#830000",t.shadowColor="rgba(75,75,75,0.75)",t.textAlign="left",t.textBaseline="alphabetic";const s=e/2,a=i/2,l=-1*Math.round(.32*this.markerSize),o=-1*Math.round(.1*this.markerSize),r=s+this.markerCoords.x+l,h=a-this.markerCoords.z+o;n(t,{text:"🚩️",x:r,z:h,size:this.markerSize}),t.fillText("🚩️",r,h)}}},847:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.throttledInvoker=void 0;const s=i(726);e.throttledInvoker=function(t){const e=[];return()=>{switch(e.length){case 0:return e.push((async()=>{await t(),e.shift()})()),e[0];case 1:{const i=e[0];return e.push((async()=>{await i,await(0,s.waitAnimationFrame)(),await t(),e.shift()})()),e[1]}case 2:return e[1];default:throw Error(`Unexpected state: promiceses=${e.length}`)}}}},726:(t,e)=>{function i(t,e=(()=>`Unexpected state: ${t}`)){if(null!=t)return t;throw Error(e())}function s(t,e,i=(()=>`Unexpected type: ${t}`)){if(t instanceof e)return t;throw Error(i())}function a(t){return{type:"game",...t}}function l(t,e,i){const s=t.offsetX*e.width/i.width,l=t.offsetY*e.height/i.height;if(s<0||s>=e.width||l<0||l>=e.height)return null;const n=s-Math.floor(e.width/2),o=Math.floor(e.height/2)-l;return a({x:Math.round(n),z:Math.round(o)})}Object.defineProperty(e,"__esModule",{value:!0}),e.threePlaneSize=e.canvasEventToGameCoords=e.gameCoords=e.gameMapSize=e.sleep=e.imageBitmapToPngBlob=e.downloadCanvasPng=e.sendCoords=e.waitAnimationFrame=e.humanreadableDistance=e.removeAllChildren=e.component=e.requireType=e.requireNonnull=void 0,e.requireNonnull=i,e.requireType=s,e.component=function(t,e){const a=i(document.getElementById(i(t,(()=>`Element ID must not null: ${t}`))),(()=>`Element not found: #${t}`));return e?s(a,e):a},e.removeAllChildren=function(t){for(;t.lastChild;)t.removeChild(t.lastChild)},e.humanreadableDistance=function(t){return t<1e3?`${t}m`:`${(t/1e3).toFixed(2)}km`},e.waitAnimationFrame=function(){return new Promise((t=>requestAnimationFrame(t)))},e.sendCoords=function(t,e,i,s){if(!s)return{x:"-",z:"-",y:"-"};const a=l(s,t,e);if(null===a)return{x:"-",z:"-",y:"-"};const n=i(a,t)??"-";return{x:a.x,z:a.z,y:n}},e.downloadCanvasPng=function(t,e){const i=document.createElement("a");i.download=t,i.href=e.toDataURL("image/png"),i.click()},e.imageBitmapToPngBlob=async function(t){const e=new OffscreenCanvas(t.height,t.width);return i(e.getContext("2d")).drawImage(t,0,0),await e.convertToBlob({type:"image/png"})},e.sleep=async function(t){return new Promise((e=>setTimeout(e,t)))},e.gameMapSize=function(t){return{type:"game",...t}},e.gameCoords=a,e.canvasEventToGameCoords=l,e.threePlaneSize=function(t,e){return{type:"threePlane",width:t,height:e}}},179:function(t,e,i){var s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const a=s(i(902)),l=new FontFace("Noto Emoji","url(../NotoEmoji-Regular.ttf)"),n=new FontFace("Heebo Medium","url(../Heebo-Medium.ttf)");let o=null;l.load().then((()=>{fonts.add(l)})).then((()=>{n.load()})).then((()=>{fonts.add(n),o?.update()})),onmessage=async t=>{const e=t.data;if(console.debug(e),!o){if(!e.canvas)throw Error("Unexpected state");o=new a.default(e.canvas,l,n)}await Object.assign(o,e).update(),postMessage({mapSize:await o.size()})}}},e={};!function i(s){var a=e[s];if(void 0!==a)return a.exports;var l=e[s]={exports:{}};return t[s].call(l.exports,l,l.exports,i),l.exports}(179)})();
//# sourceMappingURL=map-renderer.js.map