(()=>{"use strict";var t={29:(t,e,a)=>{let n,i;a.r(e),a.d(e,{deleteDB:()=>g,openDB:()=>m,unwrap:()=>p,wrap:()=>u});const s=new WeakMap,r=new WeakMap,o=new WeakMap,l=new WeakMap,h=new WeakMap;let c={get(t,e,a){if(t instanceof IDBTransaction){if("done"===e)return r.get(t);if("objectStoreNames"===e)return t.objectStoreNames||o.get(t);if("store"===e)return a.objectStoreNames[1]?void 0:a.objectStore(a.objectStoreNames[0])}return u(t[e])},set:(t,e,a)=>(t[e]=a,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function d(t){return"function"==typeof t?(e=t)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(p(this),t),u(s.get(this))}:function(...t){return u(e.apply(p(this),t))}:function(t,...a){const n=e.call(p(this),t,...a);return o.set(n,t.sort?t.sort():[t]),u(n)}:(t instanceof IDBTransaction&&function(t){if(r.has(t))return;const e=new Promise(((e,a)=>{const n=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",s),t.removeEventListener("abort",s)},i=()=>{e(),n()},s=()=>{a(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",i),t.addEventListener("error",s),t.addEventListener("abort",s)}));r.set(t,e)}(t),a=t,(n||(n=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>a instanceof t))?new Proxy(t,c):t);var e,a}function u(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,a)=>{const n=()=>{t.removeEventListener("success",i),t.removeEventListener("error",s)},i=()=>{e(u(t.result)),n()},s=()=>{a(t.error),n()};t.addEventListener("success",i),t.addEventListener("error",s)}));return e.then((e=>{e instanceof IDBCursor&&s.set(e,t)})).catch((()=>{})),h.set(e,t),e}(t);if(l.has(t))return l.get(t);const e=d(t);return e!==t&&(l.set(t,e),h.set(e,t)),e}const p=t=>h.get(t);function m(t,e,{blocked:a,upgrade:n,blocking:i,terminated:s}={}){const r=indexedDB.open(t,e),o=u(r);return n&&r.addEventListener("upgradeneeded",(t=>{n(u(r.result),t.oldVersion,t.newVersion,u(r.transaction))})),a&&r.addEventListener("blocked",(()=>a())),o.then((t=>{s&&t.addEventListener("close",(()=>s())),i&&t.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),o}function g(t,{blocked:e}={}){const a=indexedDB.deleteDatabase(t);return e&&a.addEventListener("blocked",(()=>e())),u(a).then((()=>{}))}const f=["get","getKey","getAll","getAllKeys","count"],w=["put","add","delete","clear"],b=new Map;function y(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(b.get(e))return b.get(e);const a=e.replace(/FromIndex$/,""),n=e!==a,i=w.includes(a);if(!(a in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!f.includes(a))return;const s=async function(t,...e){const s=this.transaction(t,i?"readwrite":"readonly");let r=s.store;return n&&(r=r.index(e.shift())),(await Promise.all([r[a](...e),i&&s.done]))[0]};return b.set(e,s),s}var I;I=c,c={...I,get:(t,e,a)=>y(t,e)||I.get(t,e,a),has:(t,e)=>!!y(t,e)||I.has(t,e)}},547:(t,e,a)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.MapStorage=e.LARGE_OBJECT_TYPES=void 0;const n=a(29),i=a(726);function s(t,e,a){for(let n=e+1;n<=a;n++)1===n&&(t.createObjectStore("maps",{keyPath:"id",autoIncrement:!0}),t.createObjectStore("largeObjects",{keyPath:["mapId","type"]})),2===n&&t.createObjectStore("selectedMap",{keyPath:"id"})}e.LARGE_OBJECT_TYPES=["biomes","splat3","splat4","rad","elevations","subElevations","prefabs","generationInfo"],e.LARGE_OBJECT_TYPES;const r=[t=>console.log("MapStorage change current map",t)];async function o(t,e){return{id:await t.put("maps",{name:e}),name:e}}async function l(t){return t._db||(t._db=await n.openDB("7dtd-map",2,{upgrade:s})),t._db}function h(t){return e.LARGE_OBJECT_TYPES.includes(t)}async function c(t,e){await t.put("selectedMap",{id:0,mapId:e})}async function d(t){const e=await t.get("selectedMap",0);if(e)return e.mapId;const a=await t.getAll("maps");if(a[0])return await c(t,a[0].id),d(t);const n=await o(t,"New-World");return await c(t,n.id),d(t)}e.MapStorage=class{async put(t,e){const a=await l(this),n=await d(a);if(h(t))await a.put("largeObjects",{mapId:n,type:t,data:e});else{if("maps"!==t)throw Error(`Unreachable code: type=${t}`);await a.put("maps",{id:n,name:e})}}async getCurrent(t){const e=await l(this),a=await d(e);if(h(t))return await e.get("largeObjects",[a,t]);if("maps"===t)return i.requireNonnull(await e.get("maps",a),(()=>`Unexpected state: ${a}`));throw Error(`Unreachable code: ${t}`)}async listMaps(){return(await l(this)).getAll("maps")}async createMap(t="New-World"){const e=await l(this);return await o(e,t)}async deleteMap(t){const a=await l(this),n=t??await d(a);await Promise.all([a.delete("maps",n),...e.LARGE_OBJECT_TYPES.map((t=>a.delete("largeObjects",[n,t])))])}async changeMap(t){const e=await l(this);await Promise.all([c(e,t),...r.map((e=>e(t,this)))])}async currentId(){return d(await l(this))}static addListener(t){r.push(t)}}},407:function(t,e,a){var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(a(847)),s="🚩️";function r(t,{text:e,x:a,z:n,size:i}){t.lineWidth=Math.round(.2*i),t.strokeStyle="rgba(0, 0, 0, 0.8)",t.strokeText(e,a,n),t.lineWidth=Math.round(.1*i),t.strokeStyle="white",t.strokeText(e,a,n),t.fillText(e,a,n)}e.default=class{constructor(t){this.fontFace=null,this.canvas=t,this.showPrefabs=!0,this.biomesImg=null,this.biomesAlpha=1,this.splat3Img=null,this.splat3Alpha=1,this.splat4Img=null,this.splat4Alpha=1,this.radImg=null,this.radAlpha=1,this.brightness="100%",this.scale=.1,this.signSize=200,this.signAlpha=1,this.prefabs=[],new FontFace("Noto Sans","url(NotoEmoji-Regular.ttf)").load().then((t=>{this.fontFace=t,fonts.add(t)})),this.markerCoords=null,this.throttledUpdater=i.default((()=>this.updateImmediately()))}get width(){return Math.max(this.biomesImg?.width??0,this.splat3Img?.width??0,this.splat4Img?.width??0)}get height(){return Math.max(this.biomesImg?.height??0,this.splat3Img?.height??0,this.splat4Img?.height??0)}async update(){console.time("Map Update"),await this.throttledUpdater(),console.timeEnd("Map Update")}isBlank(){return!this.biomesImg&&!this.splat3Img&&!this.splat4Img}async updateImmediately(){if(this.isBlank())return this.canvas.width=1,void(this.canvas.height=1);this.canvas.width=this.width*this.scale,this.canvas.height=this.height*this.scale;const t=this.canvas.getContext("2d");t&&(t.scale(this.scale,this.scale),t.filter=`brightness(${this.brightness})`,this.biomesImg&&0!==this.biomesAlpha&&(t.globalAlpha=this.biomesAlpha,t.drawImage(this.biomesImg,0,0,this.width,this.height)),this.splat3Img&&0!==this.splat3Alpha&&(t.globalAlpha=this.splat3Alpha,t.drawImage(this.splat3Img,0,0,this.width,this.height)),this.splat4Img&&0!==this.splat4Alpha&&(t.globalAlpha=this.splat4Alpha,t.drawImage(this.splat4Img,0,0,this.width,this.height)),t.filter="none",this.radImg&&0!==this.radAlpha&&(t.globalAlpha=this.radAlpha,t.imageSmoothingEnabled=!1,t.drawImage(this.radImg,0,0,this.width,this.height),t.imageSmoothingEnabled=!0),t.globalAlpha=this.signAlpha,this.showPrefabs&&function(t,e){e.font=`${t.signSize}px ${t.fontFace?.family??""}`,e.fillStyle="red",e.textAlign="center",e.textBaseline="middle";const a=t.width/2,n=t.height/2,i=Math.round(.01*t.signSize),s=Math.round(.05*t.signSize);for(let o=t.prefabs.length-1;o>=0;o-=1){const l=t.prefabs[o];r(e,{text:"✘",x:a+l.x+i,z:n-l.z+s,size:t.signSize})}}(this,t),this.markerCoords&&function(t,e){if(!t.markerCoords)return;e.font=`${t.signSize}px ${t.fontFace?.family??""}`,e.fillStyle="red",e.textAlign="left",e.textBaseline="alphabetic";const a=t.width/2,n=t.height/2,i=-1*Math.round(.32*t.signSize),o=-1*Math.round(.1*t.signSize),l=a+t.markerCoords.x+i,h=n-t.markerCoords.z+o;r(e,{text:s,x:l,z:h,size:t.signSize}),e.strokeText(s,l,h),e.fillText(s,l,h)}(this,t))}}},847:(t,e,a)=>{Object.defineProperty(e,"__esModule",{value:!0});const n=a(726);e.default=function(t){let e=!1,a=null;return async()=>{e=!0,a||(a=(async()=>{for(;e;)e=!1,await t(),await n.waitAnimationFrame();a=null})())}}},726:(t,e)=>{function a(t,e=(()=>`Unexpected state: ${t}`)){if(t)return t;throw Error(e())}function n(t,e,a=(()=>`Unexpected type: ${t}`)){if(t instanceof e)return t;throw Error(a())}Object.defineProperty(e,"__esModule",{value:!0}),e.downloadCanvasPng=e.formatCoords=e.waitAnimationFrame=e.humanreadableDistance=e.removeAllChildren=e.component=e.requireType=e.requireNonnull=void 0,e.requireNonnull=a,e.requireType=n,e.component=function(t,e){const i=a(document.getElementById(a(t,(()=>`Element ID must not null: ${t}`))),(()=>`Element not found: #${t}`));return e?n(i,e):i},e.removeAllChildren=function(t){for(;t.lastChild;)t.removeChild(t.lastChild)},e.humanreadableDistance=function(t){return t<1e3?`${t}m`:`${(t/1e3).toFixed(2)}km`},e.waitAnimationFrame=function(){return new Promise((t=>requestAnimationFrame(t)))},e.formatCoords=function(t,e,a,n){if(!n)return"E/W: -, N/S: -, Elev: -";const i=n.offsetX*t.width/e.width,s=n.offsetY*t.height/e.height;return i<0||i>=t.width||s<0||s>=t.height?"E/W: -, N/S: -, Elev: -":`E/W: ${Math.round(i-t.width/2)}, N/S: ${Math.round(t.height/2-s)}, Elev: ${a({x:Math.round(i),z:Math.round(s)},t.width)??"-"}`},e.downloadCanvasPng=function(t,e){const a=document.createElement("a");a.download=t,a.href=e.toDataURL("image/png"),a.click()}},496:function(t,e,a){var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(a(407)),s=a(547),r={biomesImg:"biomes",splat3Img:"splat3",splat4Img:"splat4",radImg:"rad"};let o=null;const l=new s.MapStorage;onmessage=async t=>{const e=t.data;if(!o){if(!e.canvas)throw Error("Unexpected state");o=new i.default(e.canvas)}await Object.assign(o,e).update();for(const t of Object.entries(e))t[0]in r&&l.put(r[t[0]],t[1]);postMessage({mapSize:{width:o.width,height:o.height}})}}},e={};function a(n){var i=e[n];if(void 0!==i)return i.exports;var s=e[n]={exports:{}};return t[n].call(s.exports,s,s.exports,a),s.exports}a.d=(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a(496)})();
//# sourceMappingURL=map-renderer.js.map